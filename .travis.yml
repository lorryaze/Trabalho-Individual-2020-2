language: generic

services:
- docker

env:
  - DOCKER_COMPOSE_VERSION: 1.26.2

before_install:
- sudo rm /usr/local/bin/docker-compose
- curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- sudo mv docker-compose /usr/local/bin

install: pip install codecov

jobs:
  include:
    - stage: build
      script:
      - docker-compose up -d --build
    
    - stage: test
      script:
      - docker-compose run client yarn quasar test --unit jest
      - docker-compose run api ./test_api.sh
      after_success:
      - codecov
    
    - stage: deploy-api
      deploy:
        provider: heroku
        api_key: 
          secure: HEROKU_AUTH_TOKEN
        app: api-trabalho-indivudual
        on:
          repo: lorryaze/Trabalho-Individual-2020-2
          branch: master

    - stage: deploy-client
      deploy:
        provider: heroku
        api_key: 
          secure: HEROKU_AUTH_TOKEN
        app: client-dasdasd
        on:
          repo: lorryaze/Trabalho-Individual-2020-2
          branch: master

    - stage: test production
      script:
        - 'curl https://client-dasdasd.herokuapp.com/'
        - 'curl https://api-trabalho-indivudual.herokuapp.com/'
        